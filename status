#!/bin/bash
source ./env.bash
source ./func.bash

# Print label
printlb() {
  echo -ne '\e[1;33m'$1'\e[0;0m: '
}
printlb 'Sentinel daemon'

test -e $WORK_DIR/$PID_FILE && SPID=$(cat $_) || SPID=0

if [[ -e /proc/$SPID ]]; then
  echo -e '\e[1;32mup\e[0;0m with pid '$SPID
else
  echo -e '\e[1;31mdown\e[0;0m'
fi

echo
printlb 'Uptime'
echo $(( $(get_system_uptime) / 3600 ))' hours '$(( $(get_system_uptime) % 3600 / 60 ))' minutes'

printlb 'Load average'
echo $(get_system_la)

printlb 'CPUs'
echo $(get_system_cpu_usage)'%us '$(get_system_cpu_sys)'%sy '$(get_system_cpu_nice)'%ni '$(get_system_cpu_idle)'%id '$(get_system_cpu_wait)'%wa'

printlb 'Memory'
echo $(get_system_memory_usage)'K of '$(get_system_total_memory)'K (free: '$(get_system_free_memory)'K)'

printlb 'Swap'
TOTAL_SWAP=$(get_system_total_swap)
echo $(get_system_swap_usage)'K of '$TOTAL_SWAP'K (free: '$(get_system_free_swap)'K)'

printlb 'Tasks'
echo $(ls $TASKS_DIR | wc -l)

for task in $(ls $TASKS_DIR); do
  echo
  printlb $task
  source $TASKS_DIR/$task
  pid=$(cat $pid_file)
  if [[ -e /proc/$pid ]]; then
    echo -e '\e[1;32mup\e[0;0m with pid '$pid

    printlb '  State'
    echo $(get_state $pid)

    printlb '  Parent'
    echo $(get_ppid $pid)

    printlb '  CPU'
    echo $(get_cpu_usage $pid)'%'

    printlb '  Memory'
    echo $(get_memory_usage $pid)'K with peak of '$(get_memory_peak_usage $pid)'K'

    printlb '  Swap'
    echo $(get_swap_usage $pid)'K as of '$(( $(get_swap_usage $pid) / $TOTAL_SWAP))'%'

    printlb '  Uptime'
    uptime_ts=$(( $(date +%s) - $(stat --printf='%Y' $pid_file) ))
    echo $(( $uptime_ts / 3600 ))' hours '$(( $uptime_ts % 3600 / 60 ))' minutes'

  else
    echo -e '\e[1;31mdown\e[0;0m'
  fi
done
